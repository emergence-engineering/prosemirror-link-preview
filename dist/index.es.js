import{PluginKey as t,Plugin as e}from"prosemirror-state";import{Fragment as r,Slice as i}from"prosemirror-model";import{DecorationSet as s}from"prosemirror-view";import"y-prosemirror";const o=t=>t.addToEnd("preview",{inline:!0,group:"inline",atom:!1,attrs:{src:{default:null},alt:{default:null},title:{default:null},description:{default:null}},parseDOM:[{tag:"div",getAttrs(t){var e,r,i,s;return t instanceof HTMLElement?{src:null===(e=t.querySelector(".preview-img"))||void 0===e?void 0:e.getAttribute("src"),alt:null===(r=t.querySelector(".preview-img"))||void 0===r?void 0:r.getAttribute("alt"),title:null===(i=t.querySelector(".preview-title"))||void 0===i?void 0:i.textContent,description:null===(s=t.querySelector(".preview-description"))||void 0===s?void 0:s.textContent}:{}}}],toDOM:t=>["div",{class:"preview-root"},["img",{class:"preview-img",src:t.attrs.src,alt:t.attrs.alt}],["div",{class:"preview-title"},t.attrs.title],["div",{class:"preview-description"},t.attrs.description]]}),n=(t,e,r)=>{const i=document.createElement("div");i.className="preview-root";const s=document.createElement("img");s.classList.add("preview-img"),s.src=t.attrs.src,s.alt=t.attrs.alt;const o=document.createElement("div");o.classList.add("preview-title"),o.textContent=t.attrs.title;const n=document.createElement("div");n.classList.add("preview-description"),n.textContent=t.attrs.description,i.appendChild(s),i.appendChild(o),i.appendChild(n);const l=i;return{dom:l,update:t=>{if(t.type!=t.type)return!1;const e=l.querySelector("img"),r=l.querySelector(".preview-title"),i=l.querySelector(".preview-description");return!!(e&&r&&i)&&(e.src=t.attrs.src,e.alt=t.attrs.alt,i.textContent=t.attrs.description,r.textContent=t.attrs.title,!0)},selectNode:()=>{const{state:t,dispatch:i}=e;i(t.tr.setMeta("selectedNode",r()))},deselectNode:()=>{const{state:t,dispatch:r}=e;r(t.tr.setMeta("selectedNode",null))},destroy:()=>{l.remove()}}},l=new t("previewPlugin"),d=(t,o)=>new e({key:l,state:{init:()=>[],apply:(t,e,r,i)=>e},props:{decorations:t=>s.empty,transformPasted:(e,s)=>{var n;let d={},c=s.state.tr;c.selection.empty||c.deleteSelection(),c.setMeta(l,{id:d,pos:c.selection.from,type:"add"}),s.dispatch(c);const p=null===(n=e.content.firstChild)||void 0===n?void 0:n.textContent;let u=null;try{u=new URL(p||"").origin}catch(t){return e}if(p&&u){o(p).then((e=>{const{title:r,description:i,images:o}=e,n={title:r,description:i,src:o[0],url:p},c=t.nodes.preview.create(n);let u=a(s.state,d);null!=u&&setTimeout((()=>{s.dispatch(s.state.tr.replaceWith(u,u,c).setMeta(l,{type:"remove",id:d}))}),5e3)}),(()=>{s.dispatch(c.setMeta(l,{type:"remove",id:d}))}));const e=r.empty;return new i(e,0,0)}return e},nodeViews:{preview:n}}}),a=(t,e)=>{let r=l.getState(t).find(void 0,void 0,(t=>t.id==e));return r.length?r[0].from:null};export{o as addPreviewNode,n as previewNodeView,d as previewPlugin};
